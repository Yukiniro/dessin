!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).zCanvas=e()}(this,function(){"use strict";function e(e,t){var i,n=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)),n}function o(n){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?e(Object(o),!0).forEach(function(t){var e,i;e=n,t=o[i=t],i in e?Object.defineProperty(e,i,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[i]=t}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(o,t))})}return n}function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function t(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function h(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function a(i){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=s(i);return h(this,n?(t=s(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function c(t,e,i){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){t=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=s(t)););return t}(t,e);if(t){e=Object.getOwnPropertyDescriptor(t,e);return e.get?e.get.call(i):e.value}})(t,e,i||t)}function l(t){return function(t){if(Array.isArray(t))return f(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return f(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(i="Object"===i&&t.constructor?t.constructor.name:i)||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?f(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}var _,d,y,g,p,v,E,T={ARGUMENT_ERROR:"ARGUMENT_ERROR",MOUSE_DOWN:"MOUSE_DOWN",MOUSE_UP:"MOUSE_UP",MOUSE_MOVE:"MOUSE_MOVE",MOUSE_DRAG:"MOUSE_DRAG",MOUSE_DROP:"MOUSE_DROP",MOUSE_HOVER:"MOUSE_HOVER",SPRITE_TYPE_TEXT:"TEXT",SPRITE_TYPE_PATH:"PATH",SPRITE_TYPE_IMAGE:"IMAGE",SPRITE_TYPE_RECT:"RECT",SPRITE_TYPE_POLYGON:"POLYGON",SPRITE_TYPE_CIRCLE:"CIRCLE",SPRITE_TYPE_ELLIPSE:"ELLIPSE",SPRITE_TYPE_LINE:"LINE",LEFT_TOP:"LEFT_TOP",CENTER_TOP:"CENTER_TOP",RIGHT_TOP:"RIGHT_TOP",RIGHT_CENTER:"RIGHT_CENTER",RIGHT_BOTTOM:"RIGHT_BOTTOM",CENTER_BOTTOM:"CENTER_BOTTOM",LEFT_BOTTOM:"LEFT_BOTTOM",LEFT_CENTER:"LEFT_CENTER",CENTER:"CENTER",ROTATE:"ROTATE",NONE:"NONE",SELF:"SELF"},O=(_=Object.prototype.hasOwnProperty,{isUndefined:function(t){return void 0===t},isObject:function(t){return"object"===i(t)&&null!==t},deepClone:function(t){var e=this;if(this.isObject(t)){if(Array.isArray(t))return t.map(function(t){return e.deepClone(t)});var i,n={};for(i in t)_.call(t,i)&&(n[i]=this.deepClone(t[i]));return n}return t},mixin:function(t,e){return Object.assign(t,this.deepClone(e))},removeFromArray:function(t,e){if(!Array.isArray(t))throw T.ARGUMENT_ERROR;e=t.indexof(e);-1!==e&&t.splice(e,1)},addEventListener:function(t,e,i){if(!t)throw new Error(T.ARGUMENT_ERROR);t.addEventListener?t.addEventListener(e,i):t.attachEvent&&t.attachEvent("on".concat(e),i)},removeEventListener:function(t,e,i){if(!t)throw new Error(T.ARGUMENT_ERROR);t.removeEventListener?t.removeEventListener(e,i):t.detachEvent&&t.detachEvent(e,i)},css:function(t,e){for(var i in e)_.call(e,i)&&(t.style[i]=e[i])},calcTextSize:function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=i.fontSize,o=i.fontFamily,r=i.fontStyle,i=i.fontWeight;t.save(),t.font="".concat(r," ").concat(i," ").concat(n,"px ").concat(o);n=t.measureText(e),o=n.width,e=n.fontBoundingBoxAscent,n=n.fontBoundingBoxDescent;return t.restore(),{width:o,height:e+n,fontBoundingBoxAscent:e}},renderLine:function(t,e,i,n,o){var r=e.x,s=e.y,e=i.x,i=i.y,o=o&&o.dash||[];t.save(),t.fillStyle=n,t.beginPath(),t.setLineDash(o),t.moveTo(r,s),t.lineTo(e,i),t.stroke(),t.restore()},calePointInRect:function(t,e){var i=e.x,n=e.y,o=e.width,r=e.height,s={x:0,y:0};switch(t){case T.LEFT_TOP:s={x:i,y:n};break;case T.CENTER_TOP:s={x:i+o/2,y:n};break;case T.RIGHT_TOP:s={x:i+o,y:n};break;case T.RIGHT_CENTER:s={x:i+o,y:n+r/2};break;case T.RIGHT_BOTTOM:s={x:i+o,y:n+r};break;case T.CENTER_BOTTOM:s={x:i+o/2,y:n+r};break;case T.LEFT_BOTTOM:s={x:i,y:n+r};break;case T.LEFT_CENTER:s={x:i,y:n+r/2};break;case T.CENTER:s={x:i+o/2,y:n+r/2}}return s}}),R=(d=[],{add:function(t){d.includes(t)||d.push(t)},remove:function(t){O.removeFromArray(d,t)},forEachItem:function(i){var n=this;d.forEach(function(t,e){i.call(n,t,e)})},size:function(){return d.length},removeAll:function(){d.length=0},inserAt:function(t,e){d.splice(e,0,t)},includes:function(t){return d.includes(t)}}),m={on:function(t,e){y[t]=y[t]||[],y[t].push(e)},off:function(t,e){y[t]&&O.removeFromArray(y[t],e)},fire:function(){var e=this,i=Array.prototype.slice.call(arguments),t=i[0];O.removeFromArray(i,t),(y[t]||[]).forEach(function(t){t.call.apply(t,[e].concat(l(i)))})}},k=(p=g=null,E=v=!(y={}),{bindView:function(t,e){g&&(O.removeEventListener(g,"mousedown",x),O.removeEventListener(g,"mousemove",C)),g=e,p=t,O.addEventListener(g,"mousedown",x),O.addEventListener(g,"mousemove",C)}});function x(t){v=!0,p.fireEvent(T.MOUSE_DOWN,t),O.addEventListener(document.body,"mouseup",w)}function C(t){var e=T.MOUSE_HOVER,i=T.MOUSE_DRAG,n=T.MOUSE_MOVE;p.fireEvent(n,t),v?(p.fireEvent(i,t),E=!0):p.fireEvent(e,t)}function w(t){var e=T.MOUSE_UP,i=T.MOUSE_DROP;p.fireEvent(e,t),E&&(p.fireEvent(i,t),E=!1),v=!1,O.removeEventListener(document.body,"mouseup",w)}var S=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this._lowerCanvas=t&&t.canvas,this._upperCanvas=document.createElement("canvas"),this._size={width:500,height:500},this._viewResponse=1,this._initView(),this._updateView()}return t(e,[{key:"_initView",value:function(){var t=this._lowerCanvas.parentNode,e=t.style.position;t.insertBefore(this._upperCanvas,this._lowerCanvas.nextSibling),e&&"static"!==e||O.css(t,{position:"relative"}),O.css(this._lowerCanvas,{position:"absolute"}),O.css(this._upperCanvas,{position:"absolute"}),k.bindView(this,this._upperCanvas)}},{key:"_updateView",value:function(){var t=this._size,e=t.width,t=t.height;this._lowerCanvas.width=e,this._lowerCanvas.height=t,this._upperCanvas.width=e,this._upperCanvas.height=t,this.render()}},{key:"_clear",value:function(){var t=this.getSize(),e=t.width,t=t.height;this._lowerCanvas.getContext("2d").clearRect(0,0,e,t)}},{key:"render",value:function(){var e=this;this.forEachItem(function(t){t.render(e._lowerCanvas.getContext("2d")),t.renderTrack(e._upperCanvas.getContext("2d"))})}},{key:"getSize",value:function(){return this._size}},{key:"setSize",value:function(t){return this._size=o({},t),this._updateView(),this}}]),e}();O.mixin(S.prototype,R),O.mixin(S.prototype,m);var b=1,P={LEFT_TOP:0,CENTER_TOP:1,RIGHT_TOP:2,RIGHT_CENTER:3,RIGHT_BOTTOM:4,CENTER_BOTTOM:5,LEFT_BOTTOM:6,LEFT_CETNER:7,SELF:8,ROTATE:9,NONE:-1},F=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this._supportNodes=this.computedValue("_supportNodes",t.supportNodes,[0,1,2,3,4,5,6,7,8,9,-1]),this._lineColor=this.computedValue("_lineColor",t.lineColor,"#08b9ff"),this._nodeColor=this.computedValue("_nodeColor",t.nodeColor,"#adadad"),this._nodeRadius=this.computedValue("_nodeRadius",t.nodeRadius,4),this._rotateNodeOffset=10,this._cacheView=document.createElement("canvas"),this._cacheCtx=this._cacheView.getContext("2d")}return t(e,[{key:"computedValue",value:function(t,e,i){return(0,O.isUndefined)(e)?i:e}},{key:"renderCache",value:function(t,e){this._cacheView.width=t,this._cacheView.height=e,this._cacheCtx.save(),this._cacheCtx.strokeStyle=this._lineColor,this._cacheCtx.strokeRect(this._nodeRadius,this._nodeRadius,t-2*this._nodeRadius,e-2*this._nodeRadius),this._cacheCtx.restore(),this._renderNodes(t,e)}},{key:"render",value:function(t,e,i,n,o){i={x:e-this._nodeRadius,y:i-this._nodeRadius,width:n+2*this._nodeRadius,height:o+2*this._nodeRadius};this.renderCache(n,o),t.drawImage(this._cacheView,i.x,i.y,i.width,i.height)}},{key:"_renderNodes",value:function(n,o){var r=this;this._supportNodes.forEach(function(t){var e={x:0,y:0},i={x:r._nodeRadius,y:r._nodeRadius,width:n-2*r._nodeRadius,height:o-2*r._nodeRadius};switch(t){case 0:e=O.calePointInRect(T.LEFT_TOP,i);break;case 1:e=O.calePointInRect(T.CENTER_TOP,i);break;case 2:e=O.calePointInRect(T.RIGHT_TOP,i);break;case 3:e=O.calePointInRect(T.RIGHT_CENTER,i);break;case 4:e=O.calePointInRect(T.RIGHT_BOTTOM,i);break;case 5:e=O.calePointInRect(T.CENTER_BOTTOM,i);break;case 6:e=O.calePointInRect(T.LEFT_BOTTOM,i);break;case 7:e=O.calePointInRect(T.LEFT_CENTER,i);break;case 9:e={x:n/2,y:r._nodeRadius-r._rotateNodeOffset}}r._renderNode(e)})}},{key:"_renderNode",value:function(t){this._cacheCtx.save(),this._cacheCtx.fillStyle=this._nodeColor,this._cacheCtx.beginPath(),this._cacheCtx.arc(t.x,t.y,this._nodeRadius,0,2*Math.PI),this._cacheCtx.fill(),this._cacheCtx.restore()}}],[{key:"TRACK_NODES",value:function(){return P}}]),e}(),V=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this._type=this.computedValue("_type",t.type,""),this._x=this.computedValue("_x",t.x,0),this._y=this.computedValue("_y",t.y,0),this._width=this.computedValue("_width",t.width,0),this._height=this.computedValue("_height",t.height,0),this._angle=this.computedValue("_angle",t.angle,0),this._originX=this.computedValue("_originX",t.originX,0),this._originY=this.computedValue("_originY",t.originY,0),this._flipX=this.computedValue("_flipX",t.flipX,1),this._flipY=this.computedValue("_flipY",t.flipY,0),this._opacity=this.computedValue("_opacity",t.opacity,1),this._value=this.computedValue("_value",t.value,""),this._supportNodes=[0,1,2,3,4,5,6,7,8,9,-1],this._selected=!1,this._cacheView=document.createElement("canvas"),this._cacheCtx=this._cacheView.getContext("2d"),this._track=null}return t(e,[{key:"encode",value:function(){return{type:this.type,x:this.getX(),y:this.getY(),width:this.getWidth(),hieght:this.getHeight(),angle:this.getAngle(),originX:this.getOriginX(),originY:this.getOriginY(),flipX:this.getFlipX(),flipY:this.getFlipY(),opacity:this.getOpacity(),value:this.getValue()}}},{key:"decode",value:function(t){this._type=this.computedValue("_type",t.type,this.getType()),this._x=this.computedValue("_x",t.x,this.getX()),this._y=this.computedValue("_y",t.y,this.getY()),this._width=this.computedValue("_width",t.width,this.getWidth()),this._height=this.computedValue("_height",t.height,this.getHeight()),this._angle=this.computedValue("_angle",t.angle,this.getAngle()),this._originX=this.computedValue("_originX",t.originX,this.getOriginX()),this._originY=this.computedValue("_originY",t.originY,this.getOriginY()),this._flipX=this.computedValue("_flipX",t.flipX,this.getFlipY()),this._flipY=this.computedValue("_flipY",t.flipY,this.getFlipY()),this._opacity=this.computedValue("_opacity",t.opacity,this.getOpacity()),this._value=this.computedValue("_value",t.value,this.getValue())}},{key:"computedValue",value:function(t,e,i){return O.isUndefined(e)?i:e}},{key:"type",get:function(){return this._type}},{key:"getValue",value:function(){return this._value}},{key:"setValue",value:function(t){return this._value=t,this}},{key:"getWidth",value:function(){return this._width}},{key:"setWidth",value:function(t){return this._width=t,this}},{key:"getHeight",value:function(){return this._height}},{key:"setHeight",value:function(t){return this._height=t,this}},{key:"getSize",value:function(){return{width:this._width,height:this._height}}},{key:"setSize",value:function(t){var e=O.isUndefined;if(!(0,O.isObject)(t))throw new Error(T.ARGUMENT_ERROR);return e(t.width)||(this._width=t.width),e(t.height)||(this._height=t.height),this}},{key:"getX",value:function(){return this._x}},{key:"setX",value:function(t){return this._x=t,this}},{key:"getY",value:function(){return this._y}},{key:"setY",value:function(t){return this._y=t,this}},{key:"getPos",value:function(){return{x:this._x,y:this._y}}},{key:"setPos",value:function(t){var e=O.isObject,i=O.isUndefined;if(!e(t))throw new Error(T.ARGUMENT_ERROR);return i(t.x)||(this._x=t.x),i(t.y)||(this._y=t.y),this}},{key:"getOpacity",value:function(){return this._opacity}},{key:"setOpacity",value:function(t){return this._opacity=t,this}},{key:"getOriginX",value:function(){return this._originX}},{key:"setOriginX",value:function(t){return this._originX=t,this}},{key:"getOriginY",value:function(){return this._originY}},{key:"setOriginY",value:function(t){return this._originY=t,this}},{key:"getOrigin",value:function(){return{x:this._originX,y:this._originY}}},{key:"setOrigin",value:function(t){var e=O.isObject,i=O.isUndefined;if(!e(t))throw new Error(T.ARGUMENT_ERROR);return i(t.x)||(this._originX=t.x),i(t.y)||(this._originY=t.y),this}},{key:"getAngle",value:function(){return this._angle}},{key:"setAngle",value:function(t){return this._angle=t,this}},{key:"getFlipX",value:function(){return this._flipX}},{key:"setFlipX",value:function(t){return this._flipX=t,this}},{key:"getFlipY",value:function(){return this._flipY}},{key:"setFlipY",value:function(t){return this._flipY=t,this}},{key:"isSelected",value:function(){return this._selected}},{key:"select",value:function(){return this._selected=!0,this}},{key:"deselect",value:function(){return this._selected=!1,this}},{key:"renderCache",value:function(){}},{key:"render",value:function(){}},{key:"renderTrack",value:function(t){this._track=this._track||new F({supportNodes:this._supportNodes}),this._track.render(t,this._x,this._y,this._width,this._height)}}]),e}();return O.mixin(V.prototype,m),{Canvas:S,Text:function(){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}(n,V);var i=a(n);function n(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return r(this,n),(t=i.call(this,e))._type=T.SPRITE_TYPE_TEXT,t._fontSize=t.computedValue("_fontSize",e.fontSize,36),t._fontStyle=t.computedValue("_fontStyle",e.fontStyle,"normal"),t._fontWeight=t.computedValue("_fontWeight",e.fontWeight,"normal"),t._fontFamily=t.computedValue("_fontFamily",e.fontFamily,"sans-serif"),t._textAlign=t.computedValue("_textAlign",e.textAlign,"center"),t._lineHeight=t.computedValue("_lineHeight",e.lineHeight,1.2),t._fillColor=t.computedValue("_fillColor",e.fillColor,"#FFFFFF"),t._strokeColor=t.computedValue("_strokeColor",e.strokeColor,"#FFFFFF"),t._value=t.computedValue("_value",e.value,["Enter Your Text"]),t._supportNodes=[0,2,4,6],t._fontBoundingBoxAscent=0,t.initSize(),t.renderCache(),t}return t(n,[{key:"encode",value:function(){return o(o({},c(s(n.prototype),"encode",this).call(this)),{},{fontSize:this.getFontSize(),fontStyle:this.getFontStyle(),fontWeight:this.getFontWeight(),fontFamily:this.getFontFamily(),textAlign:this.getTextAlign(),lienHeight:this.getLineHeight()})}},{key:"decode",value:function(t){c(s(n.prototype),"decode",this).call(this,t),this._fontSize=this.computedValue("_fontSize",t.fontSize,this.getFontSize()),this._fontStyle=this.computedValue("_fontStyle",t.fontStyle,this.getFontStyle()),this._fontWeight=this.computedValue("_fontWeight",t.fontWeight,this.getFontWeight()),this._textAlign=this.computedValue("_textAlgin",t.textAlign,this.getTextAlign()),this._lineHeight=this.computedValue("_lineHeight",t.lineHeight,this.getLineHeight()),this.initSize(),this.renderCache()}},{key:"_calcSize",value:function(){var o=this;return this._value.reduce(function(t,e){var i={fontSize:o._fontSize,fontFamily:o._fontFamily,fontStyle:o._fontStyle,fontWeight:o._fontWeight},n=O.calcTextSize(o._cacheCtx,e,i),e=n.width,i=n.height,n=n.fontBoundingBoxAscent;return{width:Math.max(e,t.width),height:i+t.height,fontBoundingBoxAscent:n}},{width:0,height:0,fontBoundingBoxAscent:0})}},{key:"getFontSize",value:function(){return this._fontSize}},{key:"setFontSize",value:function(t){return this._fontSize=t,this}},{key:"getFontStyle",value:function(){return this._fontStyle}},{key:"setFontStyle",value:function(t){return this._fontStyle=t,this}},{key:"getFontWeight",value:function(){return this._fontWeight}},{key:"setFontWeight",value:function(t){return this._fontWeight=t,this}},{key:"getFontFamily",value:function(){return this._fontFamily}},{key:"setFontFamily",value:function(t){return this._fontFamily=t,this}},{key:"getTextAlign",value:function(){return this._textAlign}},{key:"setTextAlign",value:function(t){return this._textAlign=t,this}},{key:"getLineHeight",value:function(){return this._lineHeight}},{key:"setLineHeight",value:function(t){return this._lineHeight=t,this}},{key:"getFillColor",value:function(){return this._fillColor}},{key:"setFillColor",value:function(t){return this._fillColor=t,this}},{key:"getStrokeColor",value:function(){return this._strokeColor}},{key:"setStrokeColor",value:function(t){return this._strokeColor=t,this}},{key:"initSize",value:function(){var t=this._calcSize(),e=t.width,i=t.height,t=t.fontBoundingBoxAscent;this.setSize({width:e,height:i}),this._fontBoundingBoxAscent=t}},{key:"renderCache",value:function(){var i,n=this,t=b,o=0,e=this._width*t,r=this._height*t,s=this._fontSize*t;switch(this._textAlign){case"left":break;case"center":o=e/2;break;case"right":o=e}this._cacheView.width=e,this._cacheView.height=r,this._cacheCtx.font="".concat(this._fontStyle," ").concat(this._fontWeight," ").concat(s,"px ").concat(this._fontFamily),this._cacheCtx.fillStyle=this._fillColor,this._cacheCtx.strokeStyle=this._strokeColor,this._cacheCtx.textAlign=this._textAlign,this._value.forEach(function(t,e){i=e*n._lineHeight*s+n._fontBoundingBoxAscent,n._cacheCtx.fillText(t,o,i)})}},{key:"render",value:function(t){t.drawImage(this._cacheView,this._x,this._y,this._width,this._height)}}]),n}()}});
